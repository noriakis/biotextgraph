---
title: "wcGeneSummary"
author: "Noriaki Sato"
package: wcGeneSummary
output: 
    BiocStyle::html_document:
        toc_float: true
vignette: >
    %\VignetteIndexEntry{wcGeneSummary}
    %\VignetteEngine{knitr::knitr}
    %\VignetteEncoding{UTF-8}  
---

This package aims to visualize the word and text information contained in the gene or the other omics identifiers such as microbiome, and identify important words among the clusters, and compare the clusters based on those information. It contributes to understanding the gene clusters and aid in easy interpretation and visualization.

# Basic usage

Load the package and the database for converting identifiers.
In this example, we use mostly human-derived data, and use `org.Hs.eg.db`.

```{r load, warning=FALSE, message=FALSE}
library(wcGeneSummary)
library(org.Hs.eg.db)
library(ggplot2)
library(ggraph)
```

## Producing word clouds

The basic usage of the package is producing a word cloud of gene summaries by querying gene IDs, default to symbol.
The other type can be set by `keyType`. As many of the words are commonly observed, you should limit word frequency by `excludeFreq`, which is default to 2000. TF-IDF on the all the summary is precomputed, and `excludeTfIdf` can be specified too.

```{r basic, warning=FALSE, message=FALSE, cache=TRUE}
## Configure input genes
inpSymbol <- c("ERCC1","ERCC2","ERCC3","ERCC4","ERCC5","ERCC6","ERCC8")

gwc <- wcGeneSummary(inpSymbol)
gwc$wc
```

It accepts values of the `wordcloud()` function. `numWords` specifies how many words are to be shown on word cloud.

```{r basic2, warning=FALSE, message=FALSE, cache=TRUE}
## Use palette from palettetown, palettetown::pokepal(150) (Mewtwo!)
gwc <- wcGeneSummary(inpSymbol, random.order=FALSE,
                     numWords=100,
                     excludeTfIdf = 150,
                     colors=palette(),
                     rot.per=0.4)
gwc$wc
```

It also returns a data frame consisting of frequency of each term.

```{r table}
knitr::kable(
  head(gwc$df), caption = 'Term frequencies.',
  row.names = FALSE
)
```

N-gram is supported by library `tm`, specified by `ngram`.
Default is `1`, and the example specifying `2` is shown below.

```{r ngramwc, warning=FALSE, fig.height=6, fig.width=6}
gwc2 <- wcGeneSummary(inpSymbol, ngram=2, numWords=50)
gwc2$wc
```

One of the main questions is which words can be clustered together among the words contained in the queried gene cluster.
Word clustering (`pvclust`) and identified significant clusters based on the occurrence in the text can be visualized by specifying `tag=TRUE`.
For the significance threshold, `pvclAlpha` can be specified.

```{r tagging, warning=FALSE}
gwcl <- wcGeneSummary(inpSymbol,
                     numWords=30,
                     tag=TRUE,
                     pal = palette(),
                     rot.per=0.4)
gwcl$wc
gwcl$pvcl
```

In this example showing ERCC genes, the term `DNA repair` is clustered as expected.

## Producing correlation networks

The next main function is producing correlation networks between words based on the co-occurrence of the words in the text.

```{r basic3, warning=FALSE, message=FALSE, cache=T}
net <- wcGeneSummary(inpSymbol, plotType="network")
net$net
```

The edge label can be shown by `edgeLabel=TRUE`.  
The threhsold of correlation can be specified by `corThresh`.
The text color can be changed by `colorText=TRUE`.

```{r ngramnet, warning=FALSE, message=FALSE, cache=T}
net <- wcGeneSummary(inpSymbol, plotType="network", edgeLabel=TRUE, corThresh=0.5, numWords=20, colorText=TRUE)
net$net
```

The clustering results based on `pvclust` can be shown also on the correlation network, by the node color.

```{r tagnet, warning=FALSE, message=FALSE, cache=T}
net <- wcGeneSummary(inpSymbol, plotType="network", corThresh=0.2,
                     numWords=20, tag=TRUE)
net$net
net$pvcl
```

The genes associated with the corresponding words can be shown by specifying `genePlot=TRUE`, useful for assessing which words is associated with interesting genes.
The edges connecting words to corresponding genes are shown.

```{r gplot, warning=FALSE, message=FALSE, cache=T}
net <- wcGeneSummary(inpSymbol, plotType="network", genePlot=TRUE, corThresh=0.5, tag=TRUE, edgeLink=FALSE,
                     numWords=20)
net$net
```

The associated enriched pathways (if present) can be shown by specifying `genePathPlot`, using `ggforce`.
In this option, the function first performs over-representation analysis on the whole gene set, and plot enriched terms for included genes in the plot.
Enrichment analysis here is performed by the library `clusterProfiler` or `ReactomePA`, and one can control which pathways to plot by `geePathPlotSig` value.

```{r gpplot, warning=FALSE, message=FALSE, cache=T}
net <- wcGeneSummary(inpSymbol, plotType="network", genePathPlot="kegg", corThresh=0.5,
                     tag=TRUE, edgeLink=FALSE, genePathPlotSig=0.05, numWords=20)
net$net
```


## Visualization of PubMed information.

Using `easyPubMed`, one can perform the same analysis on PubMed text like the article title and abstract. The function queries for the input gene symbols (or microbes) and visualize.

```{r wcabst_wc, cache=TRUE}
ab <- wcAbst(inpSymbol[1:3])
ab$wc
```

As fetching the same information is not desiable and time consuming, the same object can be passed to `redo` option and reperform the analysis like tagging, or changing the visualization options.

```{r wcabst_wc_2, cache=T}
abtag <- wcAbst(redo=ab, tag=TRUE)
abtag2 <- wcAbst(redo=abtag, tag=TRUE, genePlot=TRUE, plotType="network", corThresh=0.2)
abtag$wc
abtag2$net
```


### Comparing two or more networks

One can compare two networks by providing two objects produced by wc* functions, like `wcGeneSummary` and `wcAbst`.

```{r compare, cache=T}
cxcls <- c()
for (i in c(1,2,3,5,6,8,9,10,11,12,13,14,16)){
    cxcls <- c(cxcls, paste0("CXCL",i))
}

net1 <- wcGeneSummary(inpSymbol, plotType="network", corThresh=0.5, numWords=20)
net2 <- wcGeneSummary(cxcls, plotType="network", corThresh=0.5, numWords=20)
net3 <- wcAbst(redo=ab, plotType="network", corThresh=0.2, numWords=20)

## Not having meaningful overlaps
compareWordNet(list(net1, net2), titles=c("ercc","cxcl"))
compareWordNet(list(net1, net3), titles=c("ercc","ercc-PubMed"))
compareWordNet(list(net1, net2, net3), titles=c("ercc","cxcl", "ercc-PubMed"))
```

If `tag` information is available in both gene clusters, combined tags can be visualized by `tag=TRUE`.

```{r tagcomp, cache=T}
keggPathways <- org.Hs.egPATH2EG
mappedKeys <- mappedkeys(keggPathways)
keggList <- as.list(keggPathways[mappedKeys])


net1 <- wcGeneSummary(keggList$`05210`, keyType="ENTREZID", plotType="network", corThresh=0.3, numWords=30, tag=TRUE, excludeTfIdf=150)
net2 <- wcGeneSummary(keggList$`05211`,
                      keyType="ENTREZID", plotType="network", corThresh=0.3, numWords=30, tag=TRUE, excludeTfIdf=150)

compareWordNet(list(net1, net2), tag=TRUE)
```


## Text over represenatation analysis (experimental)

```{r ora}

geneList <- keggList$`00785` # Lipoic acid metabolism
pvs <- textORA(geneList)
hist(pvs)
pvs[order(pvs)] |> head()

geneList <- keggList$`05150` # Staphylococcus aureus infection
pvs <- textORA(geneList)
hist(pvs)
pvs[order(pvs)] |> head()
```

Filter words using ORA threshold and frequency threshold by setting `ora=TRUE`.

```{r oranet, warning=FALSE, message=FALSE, cache=T}
net <- wcGeneSummary(inpSymbol, plotType="network", ora=TRUE, edgeLink=FALSE)
net$net
```

# Custom usage

## Recluster the cluster using word information

```{r textclus, warning=FALSE, message=FALSE}
simExample <- returnSim(returnExample()$color, keyType="ENSEMBL", ora=TRUE)
heatmap(simExample)
```

## Interactive inspection of Bayesian network annotated by words

In this example, a Bayesian network showing the module eigengenes relationship are inferred using `boot.strength` function in `bnlearn` from the weighted gene correlation network analysis (WGCNA) results. The modules are annotated by word clouds produced by `wcGeneSummary()`, and can be exported to the format of `Cytoscape.js` or `vis.js`. In this way, module relationship can be interactively inspected with the functional implications.

```{r mod, warning=FALSE, message=FALSE}
## In this example, we simulate WGCNA results.
## you can just use results from WGCNA.
## Assuming WGCNA results are stored in `mod`
mod <- wcGeneSummary::returnExample()
MEs <- mod$MEs
modColors <- mod$colors
ensg <- names(modColors)

# library(bnlearn)
library(igraph)

## Replace like boot.strength(mod$MEs, R=500, algorithm = "hc")
# dag <- model2network("[ME1][ME2|ME1]") # If using bnlearn
dag <- graph_from_literal( ME1-+ME2, ME1-+ME3 )

## Convert to igraph
# g <- as.igraph(dag)
g <- dag

## Assign edge attributes
## Skip, if you perform boot.strength, the edge attributes can be added from the result
# el <- data.frame(as_edgelist(g))
# colnames(el) <- c("from","to")
# el <- left_join(el, bs)
# E(g)$strength <- el$strength
# E(g)$direction <- el$direction

## Node attributes
V(g)$stripName <- gsub("ME","",V(g)$name)
sizes <- table(modColors)
V(g)$size <- as.numeric(sizes[V(g)$stripName])

## Directory to save images and a script
rootDir <- "./"
netDir <- "visCyjs"
imageDir <- "images"

dir.create(paste0(rootDir, netDir))
dir.create(paste0(rootDir, netDir, "/", imageDir))

images <- c()
plotType <- "bar"
numLim <- 200 # limit for gene number
for (i in V(g)$name){
    print(i)
    i <- as.numeric(gsub("ME","",i)) # strip ME

    queries <- ensg[modColors==i]
    if (length(queries)>numLim) {
        warning("Sampling random genes")
        queries <- queries[sample(1:length(queries), numLim)] ## Temporary restrict to randomly chosen genes, should be replaced to like kME values
    }
    
    ## Convert to ENTREZ
    entre <- AnnotationDbi::select(org.Hs.eg.db, keytype="ENSEMBL",
        keys = queries, columns = "ENTREZID")$ENTREZID
    
    if (plotType=="bar"){
        plt <- makeBar(entre, keyType="ENTREZID") # get barplot
    } else { ## If wordcloud
        # A <- wcGeneSummary(entre,
        #                    madeUpper=c("dna","rna",
        #                                tolower(keys(org.Hs.eg.db, keytype="SYMBOL"))))
        # palNum <- sample(1:151,1) # palettetown
        # 
        # ## This time use ggwordcloud()
        # plt <- ggwordcloud::ggwordcloud(A$df$word, A$df$freq,
        #                      shape="circle", min.freq = 10,
        #                      rot.per = 0.5, random.order = FALSE,
        #                      colors = pokepal(palNum))+
        #          scale_size_area(max_size = 40)
    }
    ## Save images
    ggsave(paste0(rootDir, netDir, "/", imageDir, "/", i ,".png"),
           plt, dpi=300, width=10, height=10)
    ## Store image dir
    images <- c(images, paste0(imageDir, "/", i ,".png"))
}
V(g)$image <- images

## Node shape
if (plotType=="bar"){
    V(g)$shape <- rep("rectangle", length(V(g))) 
} else {
    V(g)$shape <- rep("circle", length(V(g)))
}

## Scale the node size
sizeMin <- 50
sizeMax <- 200
rawMin <- min(V(g)$size)
rawMax <- max(V(g)$size)
scf <- (sizeMax-sizeMin)/(rawMax-rawMin)
V(g)$size <- scf * V(g)$size + sizeMin - scf * rawMin

## Export
exportCyjs(g, rootDir, netDir)
# or, exportVisjs(g, rootDir, netDir)
```

Use like `http-server` in the directory containing a exported JavaScript, and interactively inspect the module relationship with word information.

The example visualization is shown below (not by the code above).

![Example visualization of a Bayesian network](https://github.com/noriakis/software/blob/main/images/wcbn.png?raw=true)

## Annotating module eigengenes dendrogram

As users of WGCNA typically plot dendrogramm and heatmap of module eigengenes using `plotEigengeneNetworks`, it is useful to combine with wcGeneSummary, which plot additional word information on a dendrogram with one line.

```{r wgcna, warning=FALSE, message=FALSE, cache=T}
# WGCNA::plotEigengeneNetworks(mod$MEs, mod$colors, plotHeatmaps = FALSE)
plotEigengeneNetworksWithWords(MEs, modColors)
```

```{r}
sessionInfo()
```